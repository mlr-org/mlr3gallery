---
title: "Integer hyperparameters in tuners for real-valued search spaces"
description: |
  How to tune integer hyperparameter with tuner that can only suggest real numbers.
author:
  - name: Marc Becker
date: 07-08-2020
output:
  distill::distill_article:
    self_contained: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  R.options = list(width = 80)
)
lgr::get_logger("mlr3")$set_threshold("warn")
lgr::get_logger("bbotk")$set_threshold("warn")
```

## Intro

`Tuner` for real-valued search spaces are not able to produce integer
hyperparameter values by themselves. However, it is possible to transform the
real values proposed by a `Tuner` to integers before passing them to the learner
in the evaluation. We show how to add a parameter transformation to a
`ParamSet`and apply this set in the tuning process.

## Task and Learner

First, we take a learner with a integer-valued hyperparameter.

```{r}
library(mlr3)
library(mlr3learners)
library(mlr3tuning)
library(paradox)

learner = lrn("classif.kknn", predict_type = "prob")
learner$param_set$values$kernel = "triangular"
print(learner$param_set)
```

We want to tune the integer-valued hyperparameter `k` which defines the numbers
of neighbors.

```{r}
task = tsk("iris")
print(task)
```

We choose the `iris` dataset to demonstrate the tuning.

# Tuning

```{r}
tuner = tnr("gensa")
print(tuner)
```

The `param_classes` field of `TunerGenSA` states that the tuner only supports
real-valued (`ParamDbl`) hyperparameter tuning.

To get integer-valued hyperparameter values for `k`, we construct a search space
with a transformation function.

```{r}
search_space = ParamSet$new(params = list(
  ParamDbl$new("k", lower = 3, upper = 7)
))

search_space$trafo = function(x, param_set) {
  x$k = as.integer(round(x$k))
  return(x)
}
```

We construct the other objects needed for tuning.

```{r}
terminator = term("evals", n_evals = 20)
resampling = rsmp("holdout")
measure = msr("classif.ce")


instance = TuningInstanceSingleCrit$new(
  task = task,
  learner = learner,
  resampling = resampling,
  measure = measure,
  search_space = search_space,
  terminator = terminator)
```

We start the tuning and compare the results of the search space to the results
in the space of the learners hyperparameter set.

```{r}
tuner$optimize(instance)
```

The optimal `k` is still a real number in the search space.

```{r}
instance$result_x_search_space
```

However, in the learners hyperparameters space, `k` is an integer value. 

```{r}
instance$result_x_domain
```

Internally, `TunerGenSA` was given the parameter types of the search space and
therefore suggested real numbers for `k`. Before the performance of the
different `k` values was evaluated, the transformation function of the
`search_space` parameter set was called and `k` was transformed to an integer
value.

We successfully tuned a integer-valued hyperparameter with `TunerGenSA` which is
only suitable for an real-valued search space. This technique is not limited to
tuning problems. `Optimizer` in [bbotk](https://bbotk.mlr-org.com) can be also
used in the same way to produce points with integer parameters.
