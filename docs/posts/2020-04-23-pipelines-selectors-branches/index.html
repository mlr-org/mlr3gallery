<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">

<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
  <meta name="generator" content="distill" />

  <style type="text/css">
  /* Hide doc at startup (prevent jankiness while JS renders/transforms) */
  body {
    visibility: hidden;
  }
  </style>

 <!--radix_placeholder_import_source-->
 <!--/radix_placeholder_import_source-->

  <!--radix_placeholder_meta_tags-->
<title>mlr3gallery: Pipelines, selectors, branches</title>

<meta property="description" itemprop="description" content="This tutorial explains how applying different preprocessing steps on different features and branching of preprocessing steps can be achieved using the mlr3pipelines package."/>

<link rel="canonical" href="https://mlr3gallery.mlr-org.com/posts/2020-04-23-pipelines-selectors-branches/"/>

<!--  https://schema.org/Article -->
<meta property="article:published" itemprop="datePublished" content="2020-04-23"/>
<meta property="article:created" itemprop="dateCreated" content="2020-04-23"/>
<meta name="article:author" content="Milan Dragicevic"/>
<meta name="article:author" content="Giuseppe Casalicchio"/>

<!--  https://developers.facebook.com/docs/sharing/webmasters#markup -->
<meta property="og:title" content="mlr3gallery: Pipelines, selectors, branches"/>
<meta property="og:type" content="article"/>
<meta property="og:description" content="This tutorial explains how applying different preprocessing steps on different features and branching of preprocessing steps can be achieved using the mlr3pipelines package."/>
<meta property="og:url" content="https://mlr3gallery.mlr-org.com/posts/2020-04-23-pipelines-selectors-branches/"/>
<meta property="og:image" content="https://mlr3gallery.mlr-org.com/posts/2020-04-23-pipelines-selectors-branches/2020-04-23-pipelines-selectors-branches_files/figure-html5/unnamed-chunk-7-1.png"/>
<meta property="og:image:width" content="1152"/>
<meta property="og:image:height" content="1152"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:site_name" content="mlr3gallery"/>

<!--  https://dev.twitter.com/cards/types/summary -->
<meta property="twitter:card" content="summary_large_image"/>
<meta property="twitter:title" content="mlr3gallery: Pipelines, selectors, branches"/>
<meta property="twitter:description" content="This tutorial explains how applying different preprocessing steps on different features and branching of preprocessing steps can be achieved using the mlr3pipelines package."/>
<meta property="twitter:url" content="https://mlr3gallery.mlr-org.com/posts/2020-04-23-pipelines-selectors-branches/"/>
<meta property="twitter:image" content="https://mlr3gallery.mlr-org.com/posts/2020-04-23-pipelines-selectors-branches/2020-04-23-pipelines-selectors-branches_files/figure-html5/unnamed-chunk-7-1.png"/>
<meta property="twitter:image:width" content="1152"/>
<meta property="twitter:image:height" content="1152"/>

<!--  https://scholar.google.com/intl/en/scholar/inclusion.html#indexing -->
<meta name="citation_title" content="mlr3gallery: Pipelines, selectors, branches"/>
<meta name="citation_fulltext_html_url" content="https://mlr3gallery.mlr-org.com/posts/2020-04-23-pipelines-selectors-branches/"/>
<meta name="citation_online_date" content="2020/04/23"/>
<meta name="citation_publication_date" content="2020/04/23"/>
<meta name="citation_author" content="Milan Dragicevic"/>
<meta name="citation_author" content="Giuseppe Casalicchio"/>
<!--/radix_placeholder_meta_tags-->
  <!--radix_placeholder_rmarkdown_metadata-->

<script type="text/json" id="radix-rmarkdown-metadata">
{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["title","categories","author","date","description","output","citation_url","canonical_url"]}},"value":[{"type":"character","attributes":{},"value":["Pipelines, selectors, branches"]},{"type":"character","attributes":{},"value":["mlr3pipelines"]},{"type":"list","attributes":{},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name"]}},"value":[{"type":"character","attributes":{},"value":["Milan Dragicevic"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name"]}},"value":[{"type":"character","attributes":{},"value":["Giuseppe Casalicchio"]}]}]},{"type":"character","attributes":{},"value":["04-23-2020"]},{"type":"character","attributes":{},"value":["This tutorial explains how applying different preprocessing steps on different features and branching of preprocessing steps can be achieved using the mlr3pipelines package."]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["distill::distill_article"]}},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["self_contained","css"]}},"value":[{"type":"logical","attributes":{},"value":[false]},{"type":"character","attributes":{},"value":["../../custom.css"]}]}]},{"type":"character","attributes":{},"value":["https://mlr3gallery.mlr-org.com/posts/2020-04-23-pipelines-selectors-branches/"]},{"type":"character","attributes":{},"value":["https://mlr3gallery.mlr-org.com/posts/2020-04-23-pipelines-selectors-branches/"]}]}
</script>
<!--/radix_placeholder_rmarkdown_metadata-->
  
  <script type="text/json" id="radix-resource-manifest">
  {"type":"character","attributes":{},"value":["2020-04-23-pipelines-selectors-branches_files/figure-html5/unnamed-chunk-10-1.png","2020-04-23-pipelines-selectors-branches_files/figure-html5/unnamed-chunk-11-1.png","2020-04-23-pipelines-selectors-branches_files/figure-html5/unnamed-chunk-13-1.png","2020-04-23-pipelines-selectors-branches_files/figure-html5/unnamed-chunk-14-1.png","2020-04-23-pipelines-selectors-branches_files/figure-html5/unnamed-chunk-7-1.png","2020-04-23-pipelines-selectors-branches_files/figure-html5/unnamed-chunk-9-1.png"]}
  </script>
  <!--radix_placeholder_navigation_in_header-->

<script type="application/javascript">

  window.headroom_prevent_pin = false;

  window.document.addEventListener("DOMContentLoaded", function (event) {

    // initialize headroom for banner
    var header = $('header').get(0);
    var headerHeight = header.offsetHeight;
    var headroom = new Headroom(header, {
      onPin : function() {
        if (window.headroom_prevent_pin) {
          window.headroom_prevent_pin = false;
          headroom.unpin();
        }
      }
    });
    headroom.init();
    if(window.location.hash)
      headroom.unpin();
    $(header).addClass('headroom--transition');

    // offset scroll location for banner on hash change
    // (see: https://github.com/WickyNilliams/headroom.js/issues/38)
    window.addEventListener("hashchange", function(event) {
      window.scrollTo(0, window.pageYOffset - (headerHeight + 25));
    });

    // responsive menu
    $('.distill-site-header').each(function(i, val) {
      var topnav = $(this);
      var toggle = topnav.find('.nav-toggle');
      toggle.on('click', function() {
        topnav.toggleClass('responsive');
      });
    });

    // nav dropdowns
    $('.nav-dropbtn').click(function(e) {
      $(this).next('.nav-dropdown-content').toggleClass('nav-dropdown-active');
      $(this).parent().siblings('.nav-dropdown')
         .children('.nav-dropdown-content').removeClass('nav-dropdown-active');
    });
    $("body").click(function(e){
      $('.nav-dropdown-content').removeClass('nav-dropdown-active');
    });
    $(".nav-dropdown").click(function(e){
      e.stopPropagation();
    });
  });
</script>

<style type="text/css">

/* Theme (user-documented overrideables for nav appearance) */

.distill-site-nav {
  color: rgba(255, 255, 255, 0.8);
  background-color: #455a64;
  font-size: 15px;
  font-weight: 300;
}

.distill-site-nav a {
  color: inherit;
  text-decoration: none;
}

.distill-site-nav a:hover {
  color: white;
}

@media print {
  .distill-site-nav {
    display: none;
  }
}

.distill-site-header {

}

.distill-site-footer {

}


/* Site Header */

.distill-site-header {
  width: 100%;
  box-sizing: border-box;
  z-index: 3;
}

.distill-site-header .nav-left {
  display: inline-block;
  margin-left: 8px;
}

@media screen and (max-width: 768px) {
  .distill-site-header .nav-left {
    margin-left: 0;
  }
}


.distill-site-header .nav-right {
  float: right;
  margin-right: 8px;
}

.distill-site-header a,
.distill-site-header .title {
  display: inline-block;
  text-align: center;
  padding: 14px 10px 14px 10px;
}

.distill-site-header .title {
  font-size: 18px;
}

.distill-site-header .logo {
  padding: 0;
}

.distill-site-header .logo img {
  display: none;
  max-height: 20px;
  width: auto;
  margin-bottom: -4px;
}

.distill-site-header .nav-image img {
  max-height: 18px;
  width: auto;
  display: inline-block;
  margin-bottom: -3px;
}



@media screen and (min-width: 1000px) {
  .distill-site-header .logo img {
    display: inline-block;
  }
  .distill-site-header .nav-left {
    margin-left: 20px;
  }
  .distill-site-header .nav-right {
    margin-right: 20px;
  }
  .distill-site-header .title {
    padding-left: 12px;
  }
}


.distill-site-header .nav-toggle {
  display: none;
}

.nav-dropdown {
  display: inline-block;
  position: relative;
}

.nav-dropdown .nav-dropbtn {
  border: none;
  outline: none;
  color: rgba(255, 255, 255, 0.8);
  padding: 16px 10px;
  background-color: transparent;
  font-family: inherit;
  font-size: inherit;
  font-weight: inherit;
  margin: 0;
  margin-top: 1px;
  z-index: 2;
}

.nav-dropdown-content {
  display: none;
  position: absolute;
  background-color: white;
  min-width: 200px;
  border: 1px solid rgba(0,0,0,0.15);
  border-radius: 4px;
  box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.1);
  z-index: 1;
  margin-top: 2px;
  white-space: nowrap;
  padding-top: 4px;
  padding-bottom: 4px;
}

.nav-dropdown-content hr {
  margin-top: 4px;
  margin-bottom: 4px;
  border: none;
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

.nav-dropdown-active {
  display: block;
}

.nav-dropdown-content a, .nav-dropdown-content .nav-dropdown-header {
  color: black;
  padding: 6px 24px;
  text-decoration: none;
  display: block;
  text-align: left;
}

.nav-dropdown-content .nav-dropdown-header {
  display: block;
  padding: 5px 24px;
  padding-bottom: 0;
  text-transform: uppercase;
  font-size: 14px;
  color: #999999;
  white-space: nowrap;
}

.nav-dropdown:hover .nav-dropbtn {
  color: white;
}

.nav-dropdown-content a:hover {
  background-color: #ddd;
  color: black;
}

.nav-right .nav-dropdown-content {
  margin-left: -45%;
  right: 0;
}

@media screen and (max-width: 768px) {
  .distill-site-header a, .distill-site-header .nav-dropdown  {display: none;}
  .distill-site-header a.nav-toggle {
    float: right;
    display: block;
  }
  .distill-site-header .title {
    margin-left: 0;
  }
  .distill-site-header .nav-right {
    margin-right: 0;
  }
  .distill-site-header {
    overflow: hidden;
  }
  .nav-right .nav-dropdown-content {
    margin-left: 0;
  }
}


@media screen and (max-width: 768px) {
  .distill-site-header.responsive {position: relative;}
  .distill-site-header.responsive a.nav-toggle {
    position: absolute;
    right: 0;
    top: 0;
  }
  .distill-site-header.responsive a,
  .distill-site-header.responsive .nav-dropdown {
    display: block;
    text-align: left;
  }
  .distill-site-header.responsive .nav-left,
  .distill-site-header.responsive .nav-right {
    width: 100%;
  }
  .distill-site-header.responsive .nav-dropdown {float: none;}
  .distill-site-header.responsive .nav-dropdown-content {position: relative;}
  .distill-site-header.responsive .nav-dropdown .nav-dropbtn {
    display: block;
    width: 100%;
    text-align: left;
  }
}

/* Site Footer */

.distill-site-footer {
  width: 100%;
  overflow: hidden;
  box-sizing: border-box;
  z-index: 3;
  margin-top: 30px;
  padding-top: 30px;
  padding-bottom: 30px;
  text-align: center;
}

/* Headroom */

d-title {
  padding-top: 6rem;
}

@media print {
  d-title {
    padding-top: 4rem;
  }
}

.headroom {
  z-index: 1000;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
}

.headroom--transition {
  transition: all .4s ease-in-out;
}

.headroom--unpinned {
  top: -100px;
}

.headroom--pinned {
  top: 0;
}

</style>

<link href="../../site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet"/>
<link href="../../site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet"/>
<script src="../../site_libs/headroom-0.9.4/headroom.min.js"></script>
<!--/radix_placeholder_navigation_in_header-->
  <!--radix_placeholder_distill-->

<style type="text/css">

body {
  background-color: white;
}

.pandoc-table {
  width: 100%;
}

.pandoc-table>caption {
  margin-bottom: 10px;
}

.pandoc-table th:not([align]) {
  text-align: left;
}

.pagedtable-footer {
  font-size: 15px;
}

.html-widget {
  margin-bottom: 2.0em;
}

.l-screen-inset {
  padding-right: 16px;
}

.l-screen .caption {
  margin-left: 10px;
}

.shaded {
  background: rgb(247, 247, 247);
  padding-top: 20px;
  padding-bottom: 20px;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

.shaded .html-widget {
  margin-bottom: 0;
  border: 1px solid rgba(0, 0, 0, 0.1);
}

.shaded .shaded-content {
  background: white;
}

.text-output {
  margin-top: 0;
  line-height: 1.5em;
}

.hidden {
  display: none !important;
}

d-article {
  padding-bottom: 30px;
}

d-appendix {
  padding-top: 30px;
}

d-article>p>img {
  width: 100%;
}

d-article iframe {
  border: 1px solid rgba(0, 0, 0, 0.1);
  margin-bottom: 2.0em;
  width: 100%;
}

figure img.external {
  background: white;
  border: 1px solid rgba(0, 0, 0, 0.1);
  box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
  padding: 18px;
  box-sizing: border-box;
}

/* CSS for table of contents */

.d-toc {
  color: rgba(0,0,0,0.8);
  font-size: 0.8em;
  line-height: 1em;
}

.d-toc-header {
  font-size: 0.6rem;
  font-weight: 400;
  color: rgba(0, 0, 0, 0.5);
  text-transform: uppercase;
  margin-top: 0;
  margin-bottom: 1.3em;
}

.d-toc a {
  border-bottom: none;
}

.d-toc ul {
  padding-left: 0;
}

.d-toc li>ul {
  padding-top: 0.8em;
  padding-left: 16px;
  margin-bottom: 0.6em;
}

.d-toc ul,
.d-toc li {
  list-style-type: none;
}

.d-toc li {
  margin-bottom: 0.9em;
}

.d-toc-separator {
  margin-top: 20px;
  margin-bottom: 2em;
}

.d-article-with-toc {
  border-top: none;
  padding-top: 0;
}



/* Tweak code blocks (note that this CSS is repeated above in an injection
   into the d-code shadow dom) */

d-code {
  overflow-x: auto !important;
}

pre.d-code code.d-code {
  padding-left: 10px;
  font-size: 12px;
  border-left: 2px solid rgba(0,0,0,0.1);
}

pre.text-output {

  font-size: 12px;
  color: black;
  background: none;
  font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.5;

  -moz-tab-size: 4;
  -o-tab-size: 4;
  tab-size: 4;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

@media(min-width: 768px) {

d-code {
  overflow-x: visible !important;
}

pre.d-code code.d-code  {
    padding-left: 18px;
    font-size: 14px;
}
pre.text-output {
  font-size: 14px;
}
}

/* Figure */

.figure {
  position: relative;
  margin-bottom: 2.5em;
  margin-top: 1.5em;
}

.figure img {
  width: 100%;
}

.figure .caption {
  color: rgba(0, 0, 0, 0.6);
  font-size: 12px;
  line-height: 1.5em;
}

.figure img.external {
  background: white;
  border: 1px solid rgba(0, 0, 0, 0.1);
  box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
  padding: 18px;
  box-sizing: border-box;
}

.figure .caption a {
  color: rgba(0, 0, 0, 0.6);
}

.figure .caption b,
.figure .caption strong, {
  font-weight: 600;
  color: rgba(0, 0, 0, 1.0);
}



/* Tweak 1000px media break to show more text */

@media(min-width: 1000px) {
  .base-grid,
  distill-header,
  d-title,
  d-abstract,
  d-article,
  d-appendix,
  distill-appendix,
  d-byline,
  d-footnote-list,
  d-citation-list,
  distill-footer {
    grid-template-columns: [screen-start] 1fr [page-start kicker-start] 80px [middle-start] 50px [text-start kicker-end] 65px 65px 65px 65px 65px 65px 65px 65px [text-end gutter-start] 65px [middle-end] 65px [page-end gutter-end] 1fr [screen-end];
    grid-column-gap: 16px;
  }

  .grid {
    grid-column-gap: 16px;
  }

  d-article {
    font-size: 1.06rem;
    line-height: 1.7em;
  }
  figure .caption, .figure .caption, figure figcaption {
    font-size: 13px;
  }
}

@media(min-width: 1180px) {
  .base-grid,
  distill-header,
  d-title,
  d-abstract,
  d-article,
  d-appendix,
  distill-appendix,
  d-byline,
  d-footnote-list,
  d-citation-list,
  distill-footer {
    grid-template-columns: [screen-start] 1fr [page-start kicker-start] 60px [middle-start] 60px [text-start kicker-end] 60px 60px 60px 60px 60px 60px 60px 60px [text-end gutter-start] 60px [middle-end] 60px [page-end gutter-end] 1fr [screen-end];
    grid-column-gap: 32px;
  }

  .grid {
    grid-column-gap: 32px;
  }
}


/* Get the citation styles for the appendix (not auto-injected on render since
   we do our own rendering of the citation appendix) */

d-appendix .citation-appendix,
.d-appendix .citation-appendix {
  font-size: 11px;
  line-height: 15px;
  border-left: 1px solid rgba(0, 0, 0, 0.1);
  padding-left: 18px;
  border: 1px solid rgba(0,0,0,0.1);
  background: rgba(0, 0, 0, 0.02);
  padding: 10px 18px;
  border-radius: 3px;
  color: rgba(150, 150, 150, 1);
  overflow: hidden;
  margin-top: -12px;
  white-space: pre-wrap;
  word-wrap: break-word;
}


/* Social footer */

.social_footer {
  margin-top: 30px;
  margin-bottom: 0;
  color: rgba(0,0,0,0.67);
}

.disqus-comments {
  margin-right: 30px;
}

.disqus-comment-count {
  border-bottom: 1px solid rgba(0, 0, 0, 0.4);
  cursor: pointer;
}

#disqus_thread {
  margin-top: 30px;
}

.article-sharing a {
  border-bottom: none;
  margin-right: 8px;
}

.article-sharing a:hover {
  border-bottom: none;
}

.sidebar-section.subscribe {
  font-size: 12px;
  line-height: 1.6em;
}

.subscribe p {
  margin-bottom: 0.5em;
}


.article-footer .subscribe {
  font-size: 15px;
  margin-top: 45px;
}


/* Improve display for browsers without grid (IE/Edge <= 15) */

.downlevel {
  line-height: 1.6em;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
  margin: 0;
}

.downlevel .d-title {
  padding-top: 6rem;
  padding-bottom: 1.5rem;
}

.downlevel .d-title h1 {
  font-size: 50px;
  font-weight: 700;
  line-height: 1.1em;
  margin: 0 0 0.5rem;
}

.downlevel .d-title p {
  font-weight: 300;
  font-size: 1.2rem;
  line-height: 1.55em;
  margin-top: 0;
}

.downlevel .d-byline {
  padding-top: 0.8em;
  padding-bottom: 0.8em;
  font-size: 0.8rem;
  line-height: 1.8em;
}

.downlevel .section-separator {
  border: none;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
}

.downlevel .d-article {
  font-size: 1.06rem;
  line-height: 1.7em;
  padding-top: 1rem;
  padding-bottom: 2rem;
}


.downlevel .d-appendix {
  padding-left: 0;
  padding-right: 0;
  max-width: none;
  font-size: 0.8em;
  line-height: 1.7em;
  margin-bottom: 0;
  color: rgba(0,0,0,0.5);
  padding-top: 40px;
  padding-bottom: 48px;
}

.downlevel .footnotes ol {
  padding-left: 13px;
}

.downlevel .base-grid,
.downlevel .distill-header,
.downlevel .d-title,
.downlevel .d-abstract,
.downlevel .d-article,
.downlevel .d-appendix,
.downlevel .distill-appendix,
.downlevel .d-byline,
.downlevel .d-footnote-list,
.downlevel .d-citation-list,
.downlevel .distill-footer,
.downlevel .appendix-bottom,
.downlevel .posts-container {
  padding-left: 40px;
  padding-right: 40px;
}

@media(min-width: 768px) {
  .downlevel .base-grid,
  .downlevel .distill-header,
  .downlevel .d-title,
  .downlevel .d-abstract,
  .downlevel .d-article,
  .downlevel .d-appendix,
  .downlevel .distill-appendix,
  .downlevel .d-byline,
  .downlevel .d-footnote-list,
  .downlevel .d-citation-list,
  .downlevel .distill-footer,
  .downlevel .appendix-bottom,
  .downlevel .posts-container {
  padding-left: 150px;
  padding-right: 150px;
  max-width: 900px;
}
}

.downlevel pre code {
  display: block;
  border-left: 2px solid rgba(0, 0, 0, .1);
  padding: 0 0 0 20px;
  font-size: 14px;
}

.downlevel code, .downlevel pre {
  color: black;
  background: none;
  font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.5;

  -moz-tab-size: 4;
  -o-tab-size: 4;
  tab-size: 4;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

</style>

<script type="application/javascript">

function is_downlevel_browser() {
  if (bowser.isUnsupportedBrowser({ msie: "12", msedge: "16"},
                                 window.navigator.userAgent)) {
    return true;
  } else {
    return window.load_distill_framework === undefined;
  }
}

// show body when load is complete
function on_load_complete() {

  // set body to visible
  document.body.style.visibility = 'visible';

  // force redraw for leaflet widgets
  if (window.HTMLWidgets) {
    var maps = window.HTMLWidgets.findAll(".leaflet");
    $.each(maps, function(i, el) {
      var map = this.getMap();
      map.invalidateSize();
      map.eachLayer(function(layer) {
        if (layer instanceof L.TileLayer)
          layer.redraw();
      });
    });
  }

  // trigger 'shown' so htmlwidgets resize
  $('d-article').trigger('shown');
}

function init_distill() {

  init_common();

  // create front matter
  var front_matter = $('<d-front-matter></d-front-matter>');
  $('#distill-front-matter').wrap(front_matter);

  // create d-title
  $('.d-title').changeElementType('d-title');

  // create d-byline
  var byline = $('<d-byline></d-byline>');
  $('.d-byline').replaceWith(byline);

  // create d-article
  var article = $('<d-article></d-article>');
  $('.d-article').wrap(article).children().unwrap();

  // move posts container into article
  $('.posts-container').appendTo($('d-article'));

  // create d-appendix
  $('.d-appendix').changeElementType('d-appendix');

  // create d-bibliography
  var bibliography = $('<d-bibliography></d-bibliography>');
  $('#distill-bibliography').wrap(bibliography);

  // flag indicating that we have appendix items
  var appendix = $('.appendix-bottom').children('h3').length > 0;

  // replace citations with <d-cite>
  $('.citation').each(function(i, val) {
    appendix = true;
    var cites = $(this).attr('data-cites').split(" ");
    var dt_cite = $('<d-cite></d-cite>');
    dt_cite.attr('key', cites.join());
    $(this).replaceWith(dt_cite);
  });
  // remove refs
  $('#refs').remove();

  // replace footnotes with <d-footnote>
  $('.footnote-ref').each(function(i, val) {
    appendix = true;
    var href = $(this).attr('href');
    var id = href.replace('#', '');
    var fn = $('#' + id);
    var fn_p = $('#' + id + '>p');
    fn_p.find('.footnote-back').remove();
    var text = fn_p.html();
    var dtfn = $('<d-footnote></d-footnote>');
    dtfn.html(text);
    $(this).replaceWith(dtfn);
  });
  // remove footnotes
  $('.footnotes').remove();

  $('h1.appendix, h2.appendix').each(function(i, val) {
    $(this).changeElementType('h3');
  });
  $('h3.appendix').each(function(i, val) {
    var id = $(this).attr('id');
    $('.d-toc a[href="#' + id + '"]').parent().remove();
    appendix = true;
    $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('d-appendix'));
  });

  // show d-appendix if we have appendix content
  $("d-appendix").css('display', appendix ? 'grid' : 'none');

  // replace code blocks with d-code
  $('pre>code').each(function(i, val) {
    var code = $(this);
    var pre = code.parent();
    var clz = "";
    var language = pre.attr('class');
    if (language) {
      // map unknown languages to "clike" (without this they just dissapear)
      if ($.inArray(language, ["bash", "clike", "css", "go", "html",
                               "javascript", "js", "julia", "lua", "markdown",
                               "markup", "mathml", "python", "svg", "xml"]) == -1)
        language = "clike";
      language = ' language="' + language + '"';
      var dt_code = $('<d-code block' + language + clz + '></d-code>');
      dt_code.text(code.text());
      pre.replaceWith(dt_code);
    } else {
      code.addClass('text-output').unwrap().changeElementType('pre');
    }
  });

  // localize layout chunks to just output
  $('.layout-chunk').each(function(i, val) {

    // capture layout
    var layout = $(this).attr('data-layout');

    // apply layout to markdown level block elements
    var elements = $(this).children().not('d-code, pre.text-output, script');
    elements.each(function(i, el) {
      var layout_div = $('<div class="' + layout + '"></div>');
      if (layout_div.hasClass('shaded')) {
        var shaded_content = $('<div class="shaded-content"></div>');
        $(this).wrap(shaded_content);
        $(this).parent().wrap(layout_div);
      } else {
        $(this).wrap(layout_div);
      }
    });


    // unwrap the layout-chunk div
    $(this).children().unwrap();
  });

  // load distill framework
  load_distill_framework();

  // wait for window.distillRunlevel == 4 to do post processing
  function distill_post_process() {

    if (!window.distillRunlevel || window.distillRunlevel < 4)
      return;

    // hide author/affiliations entirely if we have no authors
    var front_matter = JSON.parse($("#distill-front-matter").html());
    var have_authors = front_matter.authors && front_matter.authors.length > 0;
    if (!have_authors)
      $('d-byline').addClass('hidden');

    // table of contents
    if (have_authors) // adjust border if we are in authors
      $('.d-toc').parent().addClass('d-article-with-toc');

    // strip links that point to #
    $('.authors-affiliations').find('a[href="#"]').removeAttr('href');

    // hide elements of author/affiliations grid that have no value
    function hide_byline_column(caption) {
      $('d-byline').find('h3:contains("' + caption + '")').parent().css('visibility', 'hidden');
    }

    // affiliations
    var have_affiliations = false;
    for (var i = 0; i<front_matter.authors.length; ++i) {
      var author = front_matter.authors[i];
      if (author.affiliation !== "&nbsp;") {
        have_affiliations = true;
        break;
      }
    }
    if (!have_affiliations)
      $('d-byline').find('h3:contains("Affiliations")').css('visibility', 'hidden');

    // published date
    if (!front_matter.publishedDate)
      hide_byline_column("Published");

    // document object identifier
    var doi = $('d-byline').find('h3:contains("DOI")');
    var doi_p = doi.next().empty();
    if (!front_matter.doi) {
      // if we have a citation and valid citationText then link to that
      if ($('#citation').length > 0 && front_matter.citationText) {
        doi.html('Citation');
        $('<a href="#citation"></a>')
          .text(front_matter.citationText)
          .appendTo(doi_p);
      } else {
        hide_byline_column("DOI");
      }
    } else {
      $('<a></a>')
         .attr('href', "https://doi.org/" + front_matter.doi)
         .html(front_matter.doi)
         .appendTo(doi_p);
    }

     // change plural form of authors/affiliations
    if (front_matter.authors.length === 1) {
      var grid = $('.authors-affiliations');
      grid.children('h3:contains("Authors")').text('Author');
      grid.children('h3:contains("Affiliations")').text('Affiliation');
    }

    // inject pre code styles (can't do this with a global stylesheet b/c a shadow root is used)
    $('d-code').each(function(i, val) {
      var style = document.createElement('style');
      style.innerHTML = 'pre code { padding-left: 10px; font-size: 12px; border-left: 2px solid rgba(0,0,0,0.1); } ' +
                        '@media(min-width: 768px) { pre code { padding-left: 18px; font-size: 14px; } }';
      if (this.shadowRoot)
        this.shadowRoot.appendChild(style);
    });

    // move appendix-bottom entries to the bottom
    $('.appendix-bottom').appendTo('d-appendix').children().unwrap();
    $('.appendix-bottom').remove();

    // clear polling timer
    clearInterval(tid);

    // show body now that everything is ready
    on_load_complete();
  }

  var tid = setInterval(distill_post_process, 50);
  distill_post_process();

}

function init_downlevel() {

  init_common();

   // insert hr after d-title
  $('.d-title').after($('<hr class="section-separator"/>'));

  // check if we have authors
  var front_matter = JSON.parse($("#distill-front-matter").html());
  var have_authors = front_matter.authors && front_matter.authors.length > 0;

  // manage byline/border
  if (!have_authors)
    $('.d-byline').remove();
  $('.d-byline').after($('<hr class="section-separator"/>'));
  $('.d-byline a').remove();

  // remove toc
  $('.d-toc-header').remove();
  $('.d-toc').remove();
  $('.d-toc-separator').remove();

  // move appendix elements
  $('h1.appendix, h2.appendix').each(function(i, val) {
    $(this).changeElementType('h3');
  });
  $('h3.appendix').each(function(i, val) {
    $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('.d-appendix'));
  });


  // inject headers into references and footnotes
  var refs_header = $('<h3></h3>');
  refs_header.text('References');
  $('#refs').prepend(refs_header);

  var footnotes_header = $('<h3></h3');
  footnotes_header.text('Footnotes');
  $('.footnotes').children('hr').first().replaceWith(footnotes_header);

  // move appendix-bottom entries to the bottom
  $('.appendix-bottom').appendTo('.d-appendix').children().unwrap();
  $('.appendix-bottom').remove();

  // remove appendix if it's empty
  if ($('.d-appendix').children().length === 0)
    $('.d-appendix').remove();

  // prepend separator above appendix
  $('.d-appendix').before($('<hr class="section-separator" style="clear: both"/>'));

  // trim code
  $('pre>code').each(function(i, val) {
    $(this).html($.trim($(this).html()));
  });

  // move posts-container right before article
  $('.posts-container').insertBefore($('.d-article'));

  $('body').addClass('downlevel');

  on_load_complete();
}


function init_common() {

  // jquery plugin to change element types
  (function($) {
    $.fn.changeElementType = function(newType) {
      var attrs = {};

      $.each(this[0].attributes, function(idx, attr) {
        attrs[attr.nodeName] = attr.nodeValue;
      });

      this.replaceWith(function() {
        return $("<" + newType + "/>", attrs).append($(this).contents());
      });
    };
  })(jQuery);

  // prevent underline for linked images
  $('a > img').parent().css({'border-bottom' : 'none'});

  // mark non-body figures created by knitr chunks as 100% width
  $('.layout-chunk').each(function(i, val) {
    var figures = $(this).find('img, .html-widget');
    if ($(this).attr('data-layout') !== "l-body") {
      figures.css('width', '100%');
    } else {
      figures.css('max-width', '100%');
      figures.filter("[width]").each(function(i, val) {
        var fig = $(this);
        fig.css('width', fig.attr('width') + 'px');
      });

    }
  });

  // auto-append index.html to post-preview links in file: protocol
  // and in rstudio ide preview
  $('.post-preview').each(function(i, val) {
    if (window.location.protocol === "file:")
      $(this).attr('href', $(this).attr('href') + "index.html");
  });

  // get rid of index.html references in header
  if (window.location.protocol !== "file:") {
    $('.distill-site-header a[href]').each(function(i,val) {
      $(this).attr('href', $(this).attr('href').replace("index.html", "./"));
    });
  }

  // add class to pandoc style tables
  $('tr.header').parent('thead').parent('table').addClass('pandoc-table');
  $('.kable-table').children('table').addClass('pandoc-table');

  // add figcaption style to table captions
  $('caption').parent('table').addClass("figcaption");

  // initialize posts list
  if (window.init_posts_list)
    window.init_posts_list();

  // implmement disqus comment link
  $('.disqus-comment-count').click(function() {
    window.headroom_prevent_pin = true;
    $('#disqus_thread').toggleClass('hidden');
    if (!$('#disqus_thread').hasClass('hidden')) {
      var offset = $(this).offset();
      $(window).resize();
      $('html, body').animate({
        scrollTop: offset.top - 35
      });
    }
  });
}

document.addEventListener('DOMContentLoaded', function() {
  if (is_downlevel_browser())
    init_downlevel();
  else
    window.addEventListener('WebComponentsReady', init_distill);
});

</script>

<!--/radix_placeholder_distill-->
  <script src="../../site_libs/jquery-1.11.3/jquery.min.js"></script>
  <script src="../../site_libs/bowser-1.9.3/bowser.min.js"></script>
  <script src="../../site_libs/webcomponents-2.0.0/webcomponents.js"></script>
  <script src="../../site_libs/distill-2.2.21/template.v2.js"></script>
  <!--radix_placeholder_site_in_header-->
<!--/radix_placeholder_site_in_header-->

  <link rel="stylesheet" href="../../custom.css" type="text/css"/>

</head>

<body>

<!--radix_placeholder_front_matter-->

<script id="distill-front-matter" type="text/json">
{"title":"Pipelines, selectors, branches","description":"This tutorial explains how applying different preprocessing steps on different features and branching of preprocessing steps can be achieved using the mlr3pipelines package.","authors":[{"author":"Milan Dragicevic","authorURL":"#","affiliation":"&nbsp;","affiliationURL":"#"},{"author":"Giuseppe Casalicchio","authorURL":"#","affiliation":"&nbsp;","affiliationURL":"#"}],"publishedDate":"2020-04-23T00:00:00.000+00:00","citationText":"Dragicevic & Casalicchio, 2020"}
</script>

<!--/radix_placeholder_front_matter-->
<!--radix_placeholder_navigation_before_body-->
<header class="header header--fixed" role="banner">
<nav class="distill-site-nav distill-site-header">
<div class="nav-left">
<a class="logo" href="https://mlr3.mlr-org.com">
<img src="../../images/logo.png"/>
</a>
<a href="../../index.html" class="title">mlr3gallery</a>
</div>
<div class="nav-right">
<a href="https://github.com/mlr-org/mlr3gallery">
<i class="fab fa-github"></i>
</a>
<a href="javascript:void(0);" class="nav-toggle">&#9776;</a>
</div>
</nav>
</header>
<!--/radix_placeholder_navigation_before_body-->
<!--radix_placeholder_site_before_body-->
<!--/radix_placeholder_site_before_body-->

<div class="d-title">
<h1>Pipelines, selectors, branches</h1>
<p><p>This tutorial explains how applying different preprocessing steps on different features and branching of preprocessing steps can be achieved using the mlr3pipelines package.</p></p>
</div>

<div class="d-byline">
  Milan Dragicevic  
  
,   Giuseppe Casalicchio  
  
<br/>04-23-2020
</div>

<div class="d-article">
<h2 id="intro">Intro</h2>
<div class="layout-chunk" data-layout="l-body">

</div>
<p><a href="https://mlr3pipelines.mlr-org.com/">mlr3pipelines</a> offers a very flexible way to create data preprocessing steps. This is achieved by a modular approach using <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOps</code></a>. For detailed overview check the <a href="https://mlr3book.mlr-org.com/pipelines.html">mlr3book</a>.</p>
<p>Recommended prior readings:</p>
<ul>
<li><a href="https://mlr3gallery.mlr-org.com/posts/2020-03-11-mlr3pipelines-tutorial-german-credit/">mlr3pipelines tutorial - german credit</a></li>
<li><a href="https://mlr3gallery.mlr-org.com/posts/2020-01-30-impute-missing-levels/">Impute missing variables</a> .</li>
</ul>
<p>This post covers:</p>
<ol type="1">
<li>How to apply different preprocessing steps on different features</li>
<li>How to branch different preprocessing steps, which allows to select the best performing path</li>
<li>How to tune the whole pipeline</li>
</ol>
<h2 id="prerequisites">Prerequisites</h2>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
library(mlr3)
library(mlr3pipelines)
library(mlr3tuning)
library(paradox)</code></pre>
</div>
<p>The <a href="https://mlr3.mlr-org.com/reference/mlr_tasks_pima.html">Pima Indian Diabetes classification task</a> will be used.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
pima_tsk = tsk(&quot;pima&quot;)
pima_tsk$data()</code></pre>
<pre><code>
     diabetes age glucose insulin mass pedigree pregnant pressure triceps
  1:      pos  50     148      NA 33.6    0.627        6       72      35
  2:      neg  31      85      NA 26.6    0.351        1       66      29
  3:      pos  32     183      NA 23.3    0.672        8       64      NA
  4:      neg  21      89      94 28.1    0.167        1       66      23
  5:      pos  33     137     168 43.1    2.288        0       40      35
 ---                                                                     
764:      neg  63     101     180 32.9    0.171       10       76      48
765:      neg  27     122      NA 36.8    0.340        2       70      27
766:      neg  30     121     112 26.2    0.245        5       72      23
767:      pos  47     126      NA 30.1    0.349        1       60      NA
768:      neg  23      93      NA 30.4    0.315        1       70      31</code></pre>
<pre class="r"><code>
skimr::skim(pima_tsk$data())</code></pre>
<table>
<caption><span id="tab:unnamed-chunk-3">Table 1: </span>Data summary</caption>
<tbody>
<tr class="odd">
<td style="text-align: left;">Name</td>
<td style="text-align: left;">pima_tsk$data()</td>
</tr>
<tr class="even">
<td style="text-align: left;">Number of rows</td>
<td style="text-align: left;">768</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Number of columns</td>
<td style="text-align: left;">9</td>
</tr>
<tr class="even">
<td style="text-align: left;">_______________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Column type frequency:</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">factor</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">numeric</td>
<td style="text-align: left;">8</td>
</tr>
<tr class="even">
<td style="text-align: left;">________________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Group variables</td>
<td style="text-align: left;">None</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: factor</strong></p>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: left;">ordered</th>
<th style="text-align: right;">n_unique</th>
<th style="text-align: left;">top_counts</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">diabetes</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">neg: 500, pos: 268</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: numeric</strong></p>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">p0</th>
<th style="text-align: right;">p25</th>
<th style="text-align: right;">p50</th>
<th style="text-align: right;">p75</th>
<th style="text-align: right;">p100</th>
<th style="text-align: left;">hist</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">age</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">33.24</td>
<td style="text-align: right;">11.76</td>
<td style="text-align: right;">21.00</td>
<td style="text-align: right;">24.00</td>
<td style="text-align: right;">29.00</td>
<td style="text-align: right;">41.00</td>
<td style="text-align: right;">81.00</td>
<td style="text-align: left;">▇▃▁▁▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">glucose</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">0.99</td>
<td style="text-align: right;">121.69</td>
<td style="text-align: right;">30.54</td>
<td style="text-align: right;">44.00</td>
<td style="text-align: right;">99.00</td>
<td style="text-align: right;">117.00</td>
<td style="text-align: right;">141.00</td>
<td style="text-align: right;">199.00</td>
<td style="text-align: left;">▁▇▇▃▂</td>
</tr>
<tr class="odd">
<td style="text-align: left;">insulin</td>
<td style="text-align: right;">374</td>
<td style="text-align: right;">0.51</td>
<td style="text-align: right;">155.55</td>
<td style="text-align: right;">118.78</td>
<td style="text-align: right;">14.00</td>
<td style="text-align: right;">76.25</td>
<td style="text-align: right;">125.00</td>
<td style="text-align: right;">190.00</td>
<td style="text-align: right;">846.00</td>
<td style="text-align: left;">▇▂▁▁▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">mass</td>
<td style="text-align: right;">11</td>
<td style="text-align: right;">0.99</td>
<td style="text-align: right;">32.46</td>
<td style="text-align: right;">6.92</td>
<td style="text-align: right;">18.20</td>
<td style="text-align: right;">27.50</td>
<td style="text-align: right;">32.30</td>
<td style="text-align: right;">36.60</td>
<td style="text-align: right;">67.10</td>
<td style="text-align: left;">▅▇▃▁▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">pedigree</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.47</td>
<td style="text-align: right;">0.33</td>
<td style="text-align: right;">0.08</td>
<td style="text-align: right;">0.24</td>
<td style="text-align: right;">0.37</td>
<td style="text-align: right;">0.63</td>
<td style="text-align: right;">2.42</td>
<td style="text-align: left;">▇▃▁▁▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">pregnant</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">3.85</td>
<td style="text-align: right;">3.37</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">3.00</td>
<td style="text-align: right;">6.00</td>
<td style="text-align: right;">17.00</td>
<td style="text-align: left;">▇▃▂▁▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">pressure</td>
<td style="text-align: right;">35</td>
<td style="text-align: right;">0.95</td>
<td style="text-align: right;">72.41</td>
<td style="text-align: right;">12.38</td>
<td style="text-align: right;">24.00</td>
<td style="text-align: right;">64.00</td>
<td style="text-align: right;">72.00</td>
<td style="text-align: right;">80.00</td>
<td style="text-align: right;">122.00</td>
<td style="text-align: left;">▁▃▇▂▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">triceps</td>
<td style="text-align: right;">227</td>
<td style="text-align: right;">0.70</td>
<td style="text-align: right;">29.15</td>
<td style="text-align: right;">10.48</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: right;">22.00</td>
<td style="text-align: right;">29.00</td>
<td style="text-align: right;">36.00</td>
<td style="text-align: right;">99.00</td>
<td style="text-align: left;">▆▇▁▁▁</td>
</tr>
</tbody>
</table>
</div>
<h2 id="selection-of-features-for-preprocessing-steps">Selection of features for preprocessing steps</h2>
<p>Several features of the <code>pima</code> task have missing values:</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
pima_tsk$missings()</code></pre>
<pre><code>
diabetes      age  glucose  insulin     mass pedigree pregnant pressure  triceps 
       0        0        5      374       11        0        0       35      227 </code></pre>
</div>
<p>A common approach in such situations is to impute the missing values and to add a missing indicator column as explained in the <a href="https://mlr3gallery.mlr-org.com/posts/2020-01-30-impute-missing-levels/">Impute missing variables</a> post. Suppose we want to use</p>
<ul>
<li><a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_imputehist.html"><code>imputehist</code></a> on features “glucose”, “mass” and “pressure” which have only few missing values and</li>
<li><a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_imputemedian.html"><code>imputemedian</code></a> on features “insulin” and “triceps” which have much more missing values.</li>
</ul>
<p>In the following subsections, we show two approaches to implement this.</p>
<h3 id="consider-all-features-and-apply-the-preprocessing-step-only-to-certain-features">1. Consider all features and apply the preprocessing step only to certain features</h3>
<p>Using the <code>affect_columns</code> argument of a <code>PipeOp</code> to define the variables on which a <code>PipeOp</code> will operate with an appropriate <a href="https://mlr3pipelines.mlr-org.com/reference/Selector.html"><code>selector</code></a> function:</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
# imputes values based on histogram
hist_imp = po(&quot;imputehist&quot;,
              param_vals = list(affect_columns = selector_name(c(&quot;glucose&quot;, &quot;mass&quot;, &quot;pressure&quot;))))
# imputes values using the median
median_imp = po(&quot;imputemedian&quot;,
                param_vals = list(affect_columns = selector_name(c(&quot;insulin&quot;, &quot;triceps&quot;))))
# adds an indicator column for each feature with missing values
miss_ind = po(&quot;missind&quot;)</code></pre>
</div>
<p>When <code>PipeOp</code>s are constructed this way, they will perform the specified preprocessing step on the appropriate features and pass all the input features to the subsequent steps:</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
# no missings in &quot;glucose&quot;, &quot;mass&quot; and &quot;pressure&quot;
hist_imp$train(list(pima_tsk))[[1]]$missings()</code></pre>
<pre><code>
diabetes      age  insulin pedigree pregnant  triceps  glucose     mass pressure 
       0        0      374        0        0      227        0        0        0 </code></pre>
<pre class="r"><code>
# no missings in &quot;insulin&quot; and &quot;triceps&quot;
median_imp$train(list(pima_tsk))[[1]]$missings()</code></pre>
<pre><code>
diabetes      age  glucose     mass pedigree pregnant pressure  insulin  triceps 
       0        0        5       11        0        0       35        0        0 </code></pre>
</div>
<p>We construct a pipeline that combines <code>hist_imp</code> and <code>median_imp</code>. Here, <code>hist_imp</code> will impute the features “glucose”, “mass” and “pressure”, and <code>median_imp</code> will impute “insulin” and “triceps”. In each preprocessing step, all the input features are passed to the next step. In the end, we obtain a data set without missing values:</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
# combine the two impuation methods
impute_graph = hist_imp %&gt;&gt;% median_imp
impute_graph$plot(html = FALSE)</code></pre>
<p><img src="2020-04-23-pipelines-selectors-branches_files/figure-html5/unnamed-chunk-7-1.png" width="576" /></p>
<pre class="r"><code>
impute_graph$train(pima_tsk)[[1]]$missings()</code></pre>
<pre><code>
diabetes      age pedigree pregnant  glucose     mass pressure  insulin  triceps 
       0        0        0        0        0        0        0        0        0 </code></pre>
</div>
<p>The <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_missind.html"><code>missind</code></a> operator replaces features with missing values with a missing value indicator:</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
miss_ind$train(list(pima_tsk))[[1]]$data()</code></pre>
<pre><code>
     diabetes missing_glucose missing_insulin missing_mass missing_pressure missing_triceps
  1:      pos         present         missing      present          present         present
  2:      neg         present         missing      present          present         present
  3:      pos         present         missing      present          present         missing
  4:      neg         present         present      present          present         present
  5:      pos         present         present      present          present         present
 ---                                                                                       
764:      neg         present         present      present          present         present
765:      neg         present         missing      present          present         present
766:      neg         present         present      present          present         present
767:      pos         present         missing      present          present         missing
768:      neg         present         missing      present          present         present</code></pre>
</div>
<p>Obviously, this step can not be applied to the already imputed data as there are no missing values. If we want to combine the previous two imputation steps with a third step that adds missing value indicators, we would need to <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_copy.html"><code>copy</code></a> the data two times and supply the first copy to <code>impute_graph</code> and the second copy to <code>miss_ind</code> using <a href="https://mlr3pipelines.mlr-org.com/reference/gunion.html"><code>gunion</code></a>. Finally, the two outputs can be combined with <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_featureunion.html"><code>featureunion</code></a>:</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
impute_missind = po(&quot;copy&quot;, 2) %&gt;&gt;%
  gunion(list(impute_graph, miss_ind)) %&gt;&gt;%
  po(&quot;featureunion&quot;)
impute_missind$plot(html = FALSE)</code></pre>
<p><img src="2020-04-23-pipelines-selectors-branches_files/figure-html5/unnamed-chunk-9-1.png" width="576" /></p>
<pre class="r"><code>
impute_missind$train(pima_tsk)[[1]]$data()</code></pre>
<pre><code>
     diabetes age pedigree pregnant glucose mass pressure insulin triceps missing_glucose
  1:      pos  50    0.627        6     148 33.6       72     125      35         present
  2:      neg  31    0.351        1      85 26.6       66     125      29         present
  3:      pos  32    0.672        8     183 23.3       64     125      29         present
  4:      neg  21    0.167        1      89 28.1       66      94      23         present
  5:      pos  33    2.288        0     137 43.1       40     168      35         present
 ---                                                                                     
764:      neg  63    0.171       10     101 32.9       76     180      48         present
765:      neg  27    0.340        2     122 36.8       70     125      27         present
766:      neg  30    0.245        5     121 26.2       72     112      23         present
767:      pos  47    0.349        1     126 30.1       60     125      29         present
768:      neg  23    0.315        1      93 30.4       70     125      31         present
     missing_insulin missing_mass missing_pressure missing_triceps
  1:         missing      present          present         present
  2:         missing      present          present         present
  3:         missing      present          present         missing
  4:         present      present          present         present
  5:         present      present          present         present
 ---                                                              
764:         present      present          present         present
765:         missing      present          present         present
766:         present      present          present         present
767:         missing      present          present         missing
768:         missing      present          present         present</code></pre>
</div>
<h3 id="select-the-features-for-each-preprocessing-step-and-apply-the-preprocessing-steps-to-this-subset">2. Select the features for each preprocessing step and apply the preprocessing steps to this subset</h3>
<p>We can use the <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_select.html"><code>select</code></a> <code>PipeOp</code> to select the appropriate features and then apply the desired impute <code>PipeOp</code> on them:</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
hist_imp2 = po(&quot;select&quot;,
  selector = selector_name(c(&quot;glucose&quot;, &quot;mass&quot;, &quot;pressure&quot;)),
  id = &quot;slct1&quot;) %&gt;&gt;% # unique id so we can combine it in a pipeline with other select PipeOps
  po(&quot;imputehist&quot;)

hist_imp2$plot(html = FALSE)  </code></pre>
<p><img src="2020-04-23-pipelines-selectors-branches_files/figure-html5/unnamed-chunk-10-1.png" width="576" /></p>
<pre class="r"><code>
hist_imp2$train(pima_tsk)[[1]]$data()</code></pre>
<pre><code>
     diabetes glucose mass pressure
  1:      pos     148 33.6       72
  2:      neg      85 26.6       66
  3:      pos     183 23.3       64
  4:      neg      89 28.1       66
  5:      pos     137 43.1       40
 ---                               
764:      neg     101 32.9       76
765:      neg     122 36.8       70
766:      neg     121 26.2       72
767:      pos     126 30.1       60
768:      neg      93 30.4       70</code></pre>
<pre class="r"><code>
median_imp2 = po(&quot;select&quot;, selector = selector_name(c(&quot;insulin&quot;, &quot;triceps&quot;)), id = &quot;slct2&quot;) %&gt;&gt;%
  po(&quot;imputemedian&quot;)

median_imp2$train(pima_tsk)[[1]]$data()</code></pre>
<pre><code>
     diabetes insulin triceps
  1:      pos     125      35
  2:      neg     125      29
  3:      pos     125      29
  4:      neg      94      23
  5:      pos     168      35
 ---                         
764:      neg     180      48
765:      neg     125      27
766:      neg     112      23
767:      pos     125      29
768:      neg     125      31</code></pre>
</div>
<p>To reproduce the result of the fist example (1.), we need to copy the data four times and apply <code>hist_imp2</code>, <code>median_imp2</code> and <code>miss_ind</code> on each of the three copies. The fourth copy is required to select the features without missing values and to append it to the final result. We can do this as follows:</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
other_features = pima_tsk$feature_names[pima_tsk$missings()[-1] == 0]

impute_missind2 = po(&quot;copy&quot;, 4) %&gt;&gt;%
  gunion(list(hist_imp2,
    median_imp2,
    miss_ind,
    po(&quot;select&quot;, selector = selector_name(other_features), id = &quot;slct3&quot;))) %&gt;&gt;%
  po(&quot;featureunion&quot;)

impute_missind2$plot(html = FALSE)</code></pre>
<p><img src="2020-04-23-pipelines-selectors-branches_files/figure-html5/unnamed-chunk-11-1.png" width="576" /></p>
<pre class="r"><code>
impute_missind2$train(pima_tsk)[[1]]$data()</code></pre>
<pre><code>
     diabetes glucose mass pressure insulin triceps missing_glucose missing_insulin missing_mass
  1:      pos     148 33.6       72     125      35         present         missing      present
  2:      neg      85 26.6       66     125      29         present         missing      present
  3:      pos     183 23.3       64     125      29         present         missing      present
  4:      neg      89 28.1       66      94      23         present         present      present
  5:      pos     137 43.1       40     168      35         present         present      present
 ---                                                                                            
764:      neg     101 32.9       76     180      48         present         present      present
765:      neg     122 36.8       70     125      27         present         missing      present
766:      neg     121 26.2       72     112      23         present         present      present
767:      pos     126 30.1       60     125      29         present         missing      present
768:      neg      93 30.4       70     125      31         present         missing      present
     missing_pressure missing_triceps age pedigree pregnant
  1:          present         present  50    0.627        6
  2:          present         present  31    0.351        1
  3:          present         missing  32    0.672        8
  4:          present         present  21    0.167        1
  5:          present         present  33    2.288        0
 ---                                                       
764:          present         present  63    0.171       10
765:          present         present  27    0.340        2
766:          present         present  30    0.245        5
767:          present         missing  47    0.349        1
768:          present         present  23    0.315        1</code></pre>
</div>
<p>Note that when there is one input channel, it is automatically copied as many times as needed for the downstream <code>PipeOp</code>s. In other words, the code above works also without <code>po("copy", 4)</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
impute_missind3 = gunion(list(hist_imp2,
  median_imp2,
  miss_ind,
  po(&quot;select&quot;, selector = selector_name(other_features), id = &quot;slct3&quot;))) %&gt;&gt;%
  po(&quot;featureunion&quot;)

impute_missind3$train(pima_tsk)[[1]]$data()</code></pre>
<pre><code>
     diabetes glucose mass pressure insulin triceps missing_glucose missing_insulin missing_mass
  1:      pos     148 33.6       72     125      35         present         missing      present
  2:      neg      85 26.6       66     125      29         present         missing      present
  3:      pos     183 23.3       64     125      29         present         missing      present
  4:      neg      89 28.1       66      94      23         present         present      present
  5:      pos     137 43.1       40     168      35         present         present      present
 ---                                                                                            
764:      neg     101 32.9       76     180      48         present         present      present
765:      neg     122 36.8       70     125      27         present         missing      present
766:      neg     121 26.2       72     112      23         present         present      present
767:      pos     126 30.1       60     125      29         present         missing      present
768:      neg      93 30.4       70     125      31         present         missing      present
     missing_pressure missing_triceps age pedigree pregnant
  1:          present         present  50    0.627        6
  2:          present         present  31    0.351        1
  3:          present         missing  32    0.672        8
  4:          present         present  21    0.167        1
  5:          present         present  33    2.288        0
 ---                                                       
764:          present         present  63    0.171       10
765:          present         present  27    0.340        2
766:          present         present  30    0.245        5
767:          present         missing  47    0.349        1
768:          present         present  23    0.315        1</code></pre>
</div>
<p>Usually, <code>po("copy")</code> is required when there are more than one input channels and multiple output channels, and their numbers do not match.</p>
<h2 id="branching">Branching</h2>
<p>We can not know if the combination of a learner with this preprocessing graph will benefit from the imputation steps and the added missing value indicators. Maybe it would have been better to just use <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_imputemedian.html"><code>imputemedian</code></a> on all the variables. We could investigate this assumption by adding an alternative path to the graph with the mentioned <code>imputemedian</code>. This is possible using the <a href="https://mlr3pipelines.mlr-org.com/reference/branch.html">“branch”</a> <code>PipeOp</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
median_imp3 = po(&quot;imputemedian&quot;, id = &quot;simple_median&quot;) # add the id so it does not clash with `median_imp` 

branches = c(&quot;impute_missind&quot;, &quot;simple_median&quot;) # names of the branches

graph_branch = po(&quot;branch&quot;, branches) %&gt;&gt;%
  gunion(list(impute_missind, median_imp3)) %&gt;&gt;%
  po(&quot;unbranch&quot;)

graph_branch$plot(html = FALSE)</code></pre>
<p><img src="2020-04-23-pipelines-selectors-branches_files/figure-html5/unnamed-chunk-13-1.png" width="672" /></p>
</div>
<h2 id="tuning-the-pipeline">Tuning the pipeline</h2>
<p>To finalize the graph, we combine it with a rpart learner:</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
rpart_lrn = lrn(&quot;classif.rpart&quot;)

grph = graph_branch %&gt;&gt;%
  rpart_lrn

grph$plot(html = FALSE)</code></pre>
<p><img src="2020-04-23-pipelines-selectors-branches_files/figure-html5/unnamed-chunk-14-1.png" width="672" /></p>
</div>
<p>To define the parameters to be tuned, we first check the available ones in the graph:</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
grph$param_set</code></pre>
<pre><code>
ParamSet: 
                              id    class lower upper                       levels     default
 1:             branch.selection ParamFct    NA    NA impute_missind,simple_median &lt;NoDefault&gt;
 2:    imputehist.affect_columns ParamUty    NA    NA                              &lt;NoDefault&gt;
 3:  imputemedian.affect_columns ParamUty    NA    NA                              &lt;NoDefault&gt;
 4:                missind.which ParamFct    NA    NA            missing_train,all &lt;NoDefault&gt;
 5:                 missind.type ParamFct    NA    NA       numeric,factor,logical &lt;NoDefault&gt;
 6:       missind.affect_columns ParamUty    NA    NA                               &lt;Selector&gt;
 7: simple_median.affect_columns ParamUty    NA    NA                              &lt;NoDefault&gt;
 8:       classif.rpart.minsplit ParamInt     1   Inf                                       20
 9:      classif.rpart.minbucket ParamInt     1   Inf                              &lt;NoDefault&gt;
10:             classif.rpart.cp ParamDbl     0     1                                     0.01
11:     classif.rpart.maxcompete ParamInt     0   Inf                                        4
12:   classif.rpart.maxsurrogate ParamInt     0   Inf                                        5
13:       classif.rpart.maxdepth ParamInt     1    30                                       30
14:   classif.rpart.usesurrogate ParamInt     0     2                                        2
15: classif.rpart.surrogatestyle ParamInt     0     1                                        0
16:           classif.rpart.xval ParamInt     0   Inf                                       10
             value
 1: impute_missind
 2:     &lt;Selector&gt;
 3:     &lt;Selector&gt;
 4:  missing_train
 5:         factor
 6:               
 7:               
 8:               
 9:               
10:               
11:               
12:               
13:               
14:               
15:               
16:              0</code></pre>
</div>
<p>We decide to jointly tune the “branch.selection”, “classif.rpart.cp” and “classif.rpart.minbucket” hyperparameters:</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
ps = ParamSet$new(
  list(
    ParamFct$new(&quot;branch.selection&quot;, levels = c(&quot;impute_missind&quot;, &quot;simple_median&quot;)),
    ParamDbl$new(&quot;classif.rpart.cp&quot;, 0.001, 0.1),
    ParamInt$new(&quot;classif.rpart.minbucket&quot;, 1, 10)
  ))</code></pre>
</div>
<p>In order to tune the graph, it needs to be converted to a learner:</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
grph_lrn =  GraphLearner$new(grph)

cv3 = rsmp(&quot;cv&quot;, folds = 3)

set.seed(123) # for reproducibility of the folds
cv3$instantiate(pima_tsk) # to generate folds for cross validation

instance = TuningInstance$new(
  task = pima_tsk,
  learner = grph_lrn,
  resampling = rsmp(&quot;cv&quot;, folds = 3),
  measures = msr(&quot;classif.ce&quot;),
  param_set = ps,
  terminator = term(&quot;evals&quot;, n_evals = 5)
)

tuner = TunerRandomSearch$new()
set.seed(321)
tuner$tune(instance)

instance$archive()</code></pre>
<pre><code>
   nr batch_nr  resample_result task_id
1:  1        1 &lt;ResampleResult&gt;    pima
2:  2        2 &lt;ResampleResult&gt;    pima
3:  3        3 &lt;ResampleResult&gt;    pima
4:  4        4 &lt;ResampleResult&gt;    pima
5:  5        5 &lt;ResampleResult&gt;    pima
                                                                                      learner_id
1: branch.copy.simple_median.imputehist.missind.imputemedian.featureunion.unbranch.classif.rpart
2: branch.copy.simple_median.imputehist.missind.imputemedian.featureunion.unbranch.classif.rpart
3: branch.copy.simple_median.imputehist.missind.imputemedian.featureunion.unbranch.classif.rpart
4: branch.copy.simple_median.imputehist.missind.imputemedian.featureunion.unbranch.classif.rpart
5: branch.copy.simple_median.imputehist.missind.imputemedian.featureunion.unbranch.classif.rpart
   resampling_id iters params tune_x warnings errors classif.ce
1:            cv     3 &lt;list&gt; &lt;list&gt;        0      0  0.2617188
2:            cv     3 &lt;list&gt; &lt;list&gt;        0      0  0.2526042
3:            cv     3 &lt;list&gt; &lt;list&gt;        0      0  0.2500000
4:            cv     3 &lt;list&gt; &lt;list&gt;        0      0  0.2604167
5:            cv     3 &lt;list&gt; &lt;list&gt;        0      0  0.2513021</code></pre>
</div>
<p>The best performance in this short tuned experiment was achieved with “impute_missind”.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
instance$result$params</code></pre>
<pre><code>
$branch.selection
[1] &quot;impute_missind&quot;

$imputehist.affect_columns
selector_name(c(&quot;glucose&quot;, &quot;mass&quot;, &quot;pressure&quot;))

$imputemedian.affect_columns
selector_name(c(&quot;insulin&quot;, &quot;triceps&quot;))

$missind.which
[1] &quot;missing_train&quot;

$missind.type
[1] &quot;factor&quot;

$classif.rpart.xval
[1] 0

$classif.rpart.cp
[1] 0.003969142

$classif.rpart.minbucket
[1] 5</code></pre>
</div>
<h2 id="conclusion">Conclusion</h2>
<p>This post shows ways on how to specify features on which preprocessing steps are to be performed. In addition it shows how to create alternative paths in the learner graph. The preprocessing steps that can be used are not limited to imputation. Check the list of available <a href="https://mlr3pipelines.mlr-org.com/reference/index.html"><code>PipeOp</code>s</a>.</p>
<!--radix_placeholder_article_footer-->
<!--/radix_placeholder_article_footer-->
</div>

<div class="d-appendix">
</div>


<!--radix_placeholder_site_after_body-->
<!--/radix_placeholder_site_after_body-->
<!--radix_placeholder_appendices-->
<div class="appendix-bottom">
  <h3 id="citation">Citation</h3>
  <p>For attribution, please cite this work as</p>
  <pre class="citation-appendix short">Dragicevic &amp; Casalicchio (2020, April 23). mlr3gallery: Pipelines, selectors, branches. Retrieved from https://mlr3gallery.mlr-org.com/posts/2020-04-23-pipelines-selectors-branches/</pre>
  <p>BibTeX citation</p>
  <pre class="citation-appendix long">@misc{dragicevic2020pipelines,,
  author = {Dragicevic, Milan and Casalicchio, Giuseppe},
  title = {mlr3gallery: Pipelines, selectors, branches},
  url = {https://mlr3gallery.mlr-org.com/posts/2020-04-23-pipelines-selectors-branches/},
  year = {2020}
}</pre>
</div>
<!--/radix_placeholder_appendices-->
<!--radix_placeholder_navigation_after_body-->
<!--/radix_placeholder_navigation_after_body-->

</body>

</html>
