<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Hugo 0.67.0" />


<title>Encode factor levels for xgboost - mlr3 gallery</title>
<meta property="og:title" content="Encode factor levels for xgboost - mlr3 gallery">


  <link href='/favicon.ico' rel='icon' type='image/x-icon'/>



  








<link href='//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/gruvbox-dark.min.css' rel='stylesheet' type='text/css' />



<link rel="stylesheet" href="/css/fonts.css" media="all">
<link rel="stylesheet" href="/css/main.css" media="all">

<link rel="stylesheet" href="/css/custom.css">



  </head>
  <body>
    <div class="wrapper">
      <header class="header">
        <nav class="nav">
  <a href="/" class="nav-logo">
    <img src="/images/logo.png"
         width="50"
         height="50"
         alt="mlr logo">
  </a>

  <ul class="nav-links">
    
    <li><a href="/about/">About</a></li>
    
    <li><a href="https://github.com/mlr-org/mlr3gallery">GitHub</a></li>
    
    <li><a href="https://mlr3.mlr-org.com">mlr3</a></li>
    
  </ul>
</nav>

      </header>


<main class="content" role="main">

  <article class="article">
    
    <span class="article-duration">4 min read</span>
    

    <h1 class="article-title">Encode factor levels for xgboost</h1>

    
    <span class="article-date">2020-01-31 by Michel Lang</span>
    

    <div class="article-content">
      


<p>The package <a href="https://cran.r-project.org/package=xgboost">xgboost</a> unfortunately does not support handling of categorical features. Therefore it is required to manually convert factor columns to numerical dummy features. We show how to use <a href="https://mlr3pipelines.mlr-org.com">mlr3pipelines</a> to augment the <a href="https://mlr3learners.mlr-org.com/reference/LearnerClassifXgboost.html"><code>xgboost learner</code></a> with an automatic factor encoding.</p>
<div id="construct-the-base-objects" class="section level2">
<h2>Construct the Base Objects</h2>
<p>First, we take an example task with factors (<a href="https://mlr3.mlr-org.com/reference/mlr_tasks_german_credit.html"><code>german_credit</code></a>) and create the <a href="https://mlr3learners.mlr-org.com/reference/LearnerClassifXgboost.html"><code>xgboost learner</code></a>:</p>
<pre class="r"><code>library(mlr3)
library(mlr3learners)

task = tsk(&quot;german_credit&quot;)
print(task)</code></pre>
<pre><code>## &lt;TaskClassif:german_credit&gt; (1000 x 21)
## * Target: credit_risk
## * Properties: twoclass
## * Features (20):
##   - fct (12): credit_history, foreign_worker, housing, job,
##     other_debtors, other_installment_plans, personal_status_sex,
##     property, purpose, savings, status, telephone
##   - dbl (7): age, amount, duration, installment_rate, number_credits,
##     people_liable, present_residence
##   - ord (1): employment_duration</code></pre>
<pre class="r"><code>learner = lrn(&quot;classif.xgboost&quot;, nrounds = 100)
print(learner)</code></pre>
<pre><code>## &lt;LearnerClassifXgboost:classif.xgboost&gt;
## * Model: -
## * Parameters: nrounds=100, verbose=0
## * Packages: xgboost
## * Predict Type: response
## * Feature types: integer, numeric
## * Properties: importance, missings, multiclass, twoclass, weights</code></pre>
<p>We now compare the feature types of the task and the supported feature types:</p>
<pre class="r"><code>unique(task$feature_types$type)</code></pre>
<pre><code>## [1] &quot;numeric&quot; &quot;factor&quot;  &quot;ordered&quot;</code></pre>
<pre class="r"><code>learner$feature_types</code></pre>
<pre><code>## [1] &quot;integer&quot; &quot;numeric&quot;</code></pre>
<pre class="r"><code>setdiff(task$feature_types$type, learner$feature_types)</code></pre>
<pre><code>## [1] &quot;factor&quot;  &quot;ordered&quot;</code></pre>
<p>In this example, we have to convert factors and ordered factors to numeric columns to apply the xgboost learner. Because xgboost is based on decision trees (at least in its default settings), it is perfectly fine to convert the ordered factors to integer. Unordered factors must still be encoded though.</p>
</div>
<div id="construct-operators" class="section level1">
<h1>Construct Operators</h1>
<p>The factor encoder’s man page can be found under <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_encode.html"><code>mlr_pipeops_encode</code></a>. Here, we decide to use “treatment” encoding (first factor level serves as baseline, and there will be a new binary column for each additional level). We restrict the operator to factor columns using the respective <a href="https://mlr3pipelines.mlr-org.com/reference/Selector.html"><code>Selector</code></a> <code>selector_type()</code>:</p>
<pre class="r"><code>library(mlr3pipelines)
fencoder = po(&quot;encode&quot;, method = &quot;treatment&quot;,
  affect_columns = selector_type(&quot;factor&quot;))</code></pre>
<p>We can manually trigger the <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> to test the operator on our task:</p>
<pre class="r"><code>fencoder$train(list(task))</code></pre>
<pre><code>## $output
## &lt;TaskClassif:german_credit&gt; (1000 x 47)
## * Target: credit_risk
## * Properties: twoclass
## * Features (46):
##   - dbl (45): age, amount,
##     credit_history.all.credits.at.this.bank.paid.back.duly,
##     credit_history.critical.account.other.credits.existing,
##     credit_history.delay.in.paying.off.in.the.past,
##     credit_history.existing.credits.paid.back.duly.till.now, duration,
##     foreign_worker.no, housing.for.free, housing.own, installment_rate,
##     job.management.self.employed.highly.qualified.employee.officer,
##     job.skilled.employee.official, job.unskilled...resident,
##     number_credits, other_debtors.co.applicant,
##     other_debtors.guarantor, other_installment_plans.none,
##     other_installment_plans.stores, people_liable,
##     personal_status_sex.female...divorced.separated.married,
##     personal_status_sex.female...single,
##     personal_status_sex.male...married.widowed,
##     personal_status_sex.male...single, present_residence,
##     property.building.society.savings.agreement.life.insurance,
##     property.car.or.other, property.unknown.no.property,
##     purpose.business, purpose.car..used., purpose.domestic.appliances,
##     purpose.education, purpose.furniture.equipment, purpose.others,
##     purpose.radio.television, purpose.repairs, purpose.retraining,
##     savings........1000.DM, savings.100..........500.DM,
##     savings.500..........1000.DM, savings.unknown.no.savings.account,
##     status........200.DM...salary.for.at.least.1.year,
##     status.0..........200.DM, status.no.checking.account, telephone.yes
##   - ord (1): employment_duration</code></pre>
<p>The ordered factor remained untouched, all other factors have been converted to numeric columns. To also convert the ordered variable <code>employment_duration</code>, we construct the <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_colapply.html"><code>colapply</code></a> operator with the converter <code>as.integer()</code>:</p>
<pre class="r"><code>ord_to_int = po(&quot;colapply&quot;, applicator = as.integer,
  affect_columns = selector_type(&quot;ordered&quot;))</code></pre>
<p>Applied on the original task, it changes the factor column to <code>integer</code>:</p>
<pre class="r"><code>ord_to_int$train(list(task))</code></pre>
<pre><code>## $output
## &lt;TaskClassif:german_credit&gt; (1000 x 21)
## * Target: credit_risk
## * Properties: twoclass
## * Features (20):
##   - fct (12): credit_history, foreign_worker, housing, job,
##     other_debtors, other_installment_plans, personal_status_sex,
##     property, purpose, savings, status, telephone
##   - dbl (7): age, amount, duration, installment_rate, number_credits,
##     people_liable, present_residence
##   - int (1): employment_duration</code></pre>
<div id="construct-pipeline" class="section level2">
<h2>Construct Pipeline</h2>
<p>Finally, we construct a linear pipeline consisting of</p>
<ol style="list-style-type: decimal">
<li>the factor encoder <code>fencoder</code>,</li>
<li>the ordered factor converter <code>ord_to_int</code>, and</li>
<li>the xgboost base learner.</li>
</ol>
<pre class="r"><code>pipe = fencoder %&gt;&gt;% ord_to_int %&gt;&gt;% learner
print(pipe)</code></pre>
<pre><code>## Graph with 3 PipeOps:
##               ID         State        sccssors prdcssors
##           encode        &lt;list&gt;        colapply          
##         colapply        &lt;list&gt; classif.xgboost    encode
##  classif.xgboost &lt;&lt;UNTRAINED&gt;&gt;                  colapply</code></pre>
<p>The pipeline is wrapped in a <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_learners_graph.html"><code>GraphLearner</code></a> so that it behaves like a regular learner:</p>
<pre class="r"><code>glearner = GraphLearner$new(pipe)</code></pre>
<p>We can now apply the new learner on the task, here with a 3-fold cross validation:</p>
<pre class="r"><code>rr = resample(task, glearner, rsmp(&quot;cv&quot;, folds = 3))
rr$aggregate()</code></pre>
<pre><code>## classif.ce 
##  0.2519915</code></pre>
<p>Success! We augmented xgboost with handling of factors and ordered factors. If we combine this learner with a tuner from <a href="https://mlr3tuning.mlr-org.com">mlr3tuning</a>, we get a universal and competitive learner.</p>
</div>
</div>

    </div>
  </article>

  


</main>

      <footer class="footer">
        <ul class="footer-links">
          <li>
            <a href="/index.xml" type="application/rss+xml" target="_blank">RSS feed</a>
          </li>
          <li>
            <a href="https://gohugo.io/" class="footer-links-kudos">Made with <img src="/images/hugo-logo.png" alt="Img link to Hugo website" width="22" height="22"></a>
          </li>
        </ul>
      </footer>

    </div>
    



<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js"></script>



<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/r.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/yaml.min.js"></script>
<script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>



    
<script src="/js/math-code.js"></script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>


    
  </body>
</html>

